<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>keyboard_light</title>
	<style>
		#recogniting {
			background: blue;
			border: 2px solid black;
			border-radius: 100%;
			width: 30px;
			height: 30px;
		}
		#recogniting.running{
			background: red;
		}
		div.error{
			color: red;
		}
		div.nomatch {
			color: blue;
		}
		button{
			width:100px;
			height:50px;
			font-size:18px;
		}
		input[type=text]{
			width:200px;
			height:50px;
			font-size:18px;
		}
	</style>
</head>
<body>

	<h1>キーボードの光るやつ</h1>

	<div id="recogniting"></div>
  <button id="btnSwitch">
  start
  </button>
	<input type="text" name="txtb" value=""><br>
	<div id="resultList"></div>

	<!-- localhostのときのpathが分からないので、現状スクリプトを埋め込むことで動かす。 -->
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		(function($){

			// initialize
			var recognition,isRecognition = false;

			var reg_candidate;
			// jsonの取得を行う
			getJSON();

			// $(".start-btn").on("click",start);
			// ボタンのリスナー
			btnSwitch.addEventListener('click', function() {
				if(btnSwitch.innerText === 'start') {
					btnSwitch.textContent = 'stop';
					// test();
					start();
				} else {
					btnSwitch.textContent = 'start';
					stop();
				}
			});

			// 音声認識の開始
			function start(){
				recognition = new webkitSpeechRecognition(); // 音声認識
				recognition.lang = "ja";
				//変換候補数を指定
				recognition.maxAlternatives = 3;
				recognition.start(); // 認識開始
				isRecognition = true; // 認識しているかどうかのフラグを反転

				// 音声認識可能な音声が検出された場合（話始め）に発火する
				recognition.addEventListener('soundstart', function() {
					console.log('on soundstart');
					recogniting.classList.add('running');
				});
				// 音声認識可能な音声が検出されなくなったとき(話し終えた)に発火する
				recognition.addEventListener('soundend', function() {
					console.log('on soundend');
					recogniting.classList.remove('running');
					stop(); // 認識が終わったら終了する
				});
				// 音声認識サービスが結果を返すときに発火する
				recognition.addEventListener( 'result' , function(evt) {
					var results = evt.results;
					var text = '';
					console.log('result');
					for (var i = 0; i < event.results.length; i++) {
						var result = results.item(i);
						// 変換候補の取得
		        for(var j = 0; j < result.length; j++){
		            var alternavive = result.item(j);
								// 空白を削除する
								// https://www.nishishi.com/javascript-tips/trim-space-chars.html
								var transcript = alternavive.transcript.replace(/\s+/g, "");
								console.log(j + " : " + transcript);
								// regcongnition.jsonに読みの候補がある場合
								if(typeof reg_candidate[alternavive.transcript] !== "undefined"){
									text = reg_candidate[alternavive.transcript];
									console.log("find : " + text);
									break;
								}
		        }
						setLED(text);
					}
					var div = document.createElement('div');
					div.textContent = text;
					resultList.insertBefore(div, resultList.firstChild);
				});
				// 音声認識エラーが発生したときに発生します。
				recognition.addEventListener('error', function(err) {
					var div = document.createElement('div');
					div.textContent = 'error:' + err.message;
					div.classList.add('error');
					resultList.insertBefore(div, resultList.firstChild);
				});
				// 音声認識サービスが有意な認識なしに最終結果を返すときに発生します.
				// これには、ある程度の認識が必要であり、それは信頼限界を満たさないか、それを超えている。
				recognition.addEventListener('nomatch', function() {
					var div = document.createElement('div');
					div.textContent = 'no match';
					div.classList.add('nomatch');
					resultList.insertBefore(div, resultList.firstChild);
				});
			}


			// 音声認識の停止
			function stop(){
				if(isRecognition){
					recognition.stop();
					btnSwitch.textContent = 'start';
					isRecognition = false;
				}
			}

			// サーバー(node.js)に音声認識で取得したひらがなをpostする
			function setLED(s) {
				$.ajax({
          async: false,
          url: "/set",
          type: 'post',
          data:{"name": s},
          dataType: 'json'
                }).done(function(res){
                 console.debug(res);
                }).fail(function(xhr, status, error){
                   alert(status);
                });
			}

			// 認識語の候補のJSONを取得する
			// https://www.koreyome.com/web/json-data-get/
			function getJSON() {
				// XMLHttpRequest オブジェクトを生成する
			  var req = new XMLHttpRequest();
				  // XMLHttpRequest オブジェクトの状態が変化した際に呼び出されるイベントハンドラ
			  	req.onreadystatechange = function() {
						// サーバーからのレスポンスが完了し、かつ、通信が正常に終了した場合
			      if(req.readyState == 4 && req.status == 200){
							// 取得した JSON ファイルの中身を変数へ格納
			        var data = JSON.parse(req.responseText);
							// keyとvalを入れ替える
							reg_candidate = inverseObject(data);
			      }
			    };
					// HTTPメソッドとアクセスするサーバーのURLを指定
			    req.open("GET", "regcongnition.json", false);
					// 実際にサーバーへリクエストを送信
			    req.send(null);
			}

			/**
			 * https://qiita.com/alucky0707/items/de59e49de855e56be733
			 * オブジェクトのkeyとvaluesを反転させる
			 * (ex.
			 * "あ": ["阿波どこ","あはどこ","アはどこ"]
			 *   -> "阿波どこ":"あ", "あはどこ":"あ", "アはどこ":"あ"
			 * @param {Object} obj 反転させるオブジェクト
			 * @return {Object} keyとvaluesの反転したオブジェクト
			 */
			function inverseObject (obj) {
			  return Object.keys(obj).reduceRight(function (ret, k) {
					// "あ": ["阿波どこ","あはどこ","アはどこ"]
					// ここで配列を取得する
					obj[k].forEach(function( value ) {
						ret[value] = k
					});
			    return ret;
			  }, {});
			}

		})(jQuery);
	</script>
</body>
</html>
