<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>keyboard_light</title>
	<style>
		#recogniting {
			background: blue;
			border: 2px solid black;
			border-radius: 100%;
			width: 30px;
			height: 30px;
		}
		#recogniting.running{
			background: red;
		}
		div.error{
			color: red;
		}
		div.nomatch {
			color: blue;
		}
		button{
			width:100px;
			height:50px;
			font-size:18px;
		}
		input[type=text]{
			width:200px;
			height:50px;
			font-size:18px;
		}
	</style>
</head>
<body>

	<h1>キーボードの光るやつ</h1>

	<div id="recogniting"></div>
  <button id="btnSwitch">
  start
  </button>
	<input type="text" name="txtb" value=""><br>
	<div id="resultList"></div>

	<!-- localhostのときのpathが分からないので、現状スクリプトを埋め込むことで動かす。 -->
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		(function($){

			// initialize
			var recognition,isRecognition = false;

			var reg_candidate;
			// jsonの取得を行う
			reg_candidate = getJSON();

			// 母音と子音のLED表示の方法。
			// インターバルは一定時間での表示切り替え
			const INTERVAL_MODE  = 0;
			// キーイベントは、キー入力がされてから表示を切り替える
			const KEY_EVENT_MODE = 1;

			const MODE = KEY_EVENT_MODE;

			// 何m秒間LEDを点灯させるか(後で文字ごとに変更できたらいいかな)
			var lightTime = 2000;
	    // 何秒後に消灯するか(子音があるかないかで変わる)
	    var delayTime;


			// $(".start-btn").on("click",start);
			// ボタンのリスナー
			btnSwitch.addEventListener('click', function() {
				if(btnSwitch.innerText === 'start') {
					btnSwitch.textContent = 'stop';
					// test();
					start();
				} else {
					btnSwitch.textContent = 'start';
					stop();
				}
			});

			// 音声認識の開始
			function start(){
				recognition = new webkitSpeechRecognition(); // 音声認識
				recognition.lang = "ja";
				//変換候補数を指定
				recognition.maxAlternatives = 3;
				recognition.start(); // 認識開始
				isRecognition = true; // 認識しているかどうかのフラグを反転

				// 音声認識可能な音声が検出された場合（話始め）に発火する
				recognition.addEventListener('soundstart', function() {
					console.log('on soundstart');
					recogniting.classList.add('running');
				});
				// 音声認識可能な音声が検出されなくなったとき(話し終えた)に発火する
				recognition.addEventListener('soundend', function() {
					console.log('on soundend');
					recogniting.classList.remove('running');
					stop(); // 認識が終わったら終了する
				});
				// 音声認識サービスが結果を返すときに発火する
				recognition.addEventListener( 'result' , function(evt) {
					var results = evt.results;
					var text = '';
					console.log('result');
					for (var i = 0; i < event.results.length; i++) {
						var result = results.item(i);
						// 変換候補の取得
		        for(var j = 0; j < result.length; j++){
		            var alternavive = result.item(j);
								// 空白を削除する
								// https://www.nishishi.com/javascript-tips/trim-space-chars.html
								var transcript = alternavive.transcript.replace(/\s+/g, "");
								console.log(j + " : " + transcript);
								// regcongnition.jsonに読みの候補がある場合
								if(typeof reg_candidate[alternavive.transcript] !== "undefined"){
									text = reg_candidate[alternavive.transcript];
									console.log("find : " + text);
									break;
								}
		        }
						setLED(text);
					}
					var div = document.createElement('div');
					div.textContent = text;
					resultList.insertBefore(div, resultList.firstChild);
				});
				// 音声認識エラーが発生したときに発生します。
				recognition.addEventListener('error', function(err) {
					var div = document.createElement('div');
					div.textContent = 'error:' + err.message;
					div.classList.add('error');
					resultList.insertBefore(div, resultList.firstChild);
				});
				// 音声認識サービスが有意な認識なしに最終結果を返すときに発生します.
				// これには、ある程度の認識が必要であり、それは信頼限界を満たさないか、それを超えている。
				recognition.addEventListener('nomatch', function() {
					var div = document.createElement('div');
					div.textContent = 'no match';
					div.classList.add('nomatch');
					resultList.insertBefore(div, resultList.firstChild);
				});
			}


			// 音声認識の停止
			function stop(){
				if(isRecognition){
					recognition.stop();
					btnSwitch.textContent = 'start';
					isRecognition = false;
				}
			}

			// サーバー(node.js)に音声認識で取得したひらがなをpostする
			function setLED(s) {

				var romaji = kana2romaji(s);
				console.log(romaji);
				if(MODE == INTERVAL_MODE){
					// 1文字目
					sendLED(romaji[0]);
					// ローマ字2文字以上のとき
			    if(romaji.length > 1){
			      // delayTime ms後に2文字目のLEDを点灯する
			      setTimeout( function(){ sendLED(romaji[1]) }, lightTime );
						// もしある場合は3文字目のLEDを点灯する
						if(romaji.length == 3){
							setTimeout( function(){ sendLED(romaji[2]) }, lightTime*2 );
						}
					}
					// for文で回すとうまく動かなくなる。setTimeoutが原因？短時間中に複数設定するとおかしくなる？
					// for(var n=0; n<romaji.length; n++){
					// 	var c = romaji[n];
					// 	console.log(c);
					// 	setTimeout( function(){ sendLED(c) }, lightTime*n );
					// }
					delayTime = lightTime * romaji.length;
					// 消灯
			    setTimeout( function(){ sendLED("turn off") }, delayTime );
				}
				else if (MODE == KEY_EVENT_MODE) {
					// 子音が入力された回数
					var countInputedConsonant = 0;
					// 1文字目
					sendLED(romaji[0]);

					function KeyDown(e){
						// キーコード
						var key_code = e.keyCode;

						for(var n=0; n<romaji.length; n++){
							// 最後の文字なので入力を確認したらLEDを消灯する
							if(romaji.length == n+1){
								if(String.fromCharCode(key_code) === romaji[n]){
									removeLED();
								}
							}
							// 入力待機の文字切り替え
							else if(String.fromCharCode(key_code) === romaji[n] && countInputedConsonant == n){
								sendLED(romaji[n+1]);
								countInputedConsonant = 1 + countInputedConsonant;
							}
						}
					}
					// イベントの解除とLEDの消灯
					function removeLED() {
						// イベントの解除
						document.removeEventListener("keydown" , KeyDown);
						sendLED("turn off");
					}

					// イベントリスナーに対応している
					if(document.addEventListener){
						// キーボードを押したときに実行されるイベント
						document.addEventListener("keydown" , KeyDown);
					// アタッチイベントに対応している
					}else if(document.attachEvent){
						// キーボードを押したときに実行されるイベント
						document.attachEvent("onkeydown" , KeyDown);
					}

				}
			}
			// 表示するアルファベットをnodeにpostする
			function sendLED(c) {
				$.ajax({
          async: false,
          url: "/set",
          type: 'post',
          data:{"name": c},
          dataType: 'json'
                }).done(function(res){
                 console.debug(res);
                }).fail(function(xhr, status, error){
                   alert(status);
                });
			}

			// 認識語の候補のJSONを取得する
			// https://www.koreyome.com/web/json-data-get/
			function getJSON() {
				// 音声認識のパターン候補
				var pattern;
				// XMLHttpRequest オブジェクトを生成する
			  var req = new XMLHttpRequest();
				  // XMLHttpRequest オブジェクトの状態が変化した際に呼び出されるイベントハンドラ
			  	req.onreadystatechange = function() {
						// サーバーからのレスポンスが完了し、かつ、通信が正常に終了した場合
			      if(req.readyState == 4 && req.status == 200){
							// 取得した JSON ファイルの中身を変数へ格納
			        var data = JSON.parse(req.responseText);
							// keyとvalを入れ替える
							pattern = inverseObject(data);
			      }
			    };
					// HTTPメソッドとアクセスするサーバーのURLを指定
			    req.open("GET", "regcongnition.json", false);
					// 実際にサーバーへリクエストを送信
			    req.send(null);
					return pattern;
			}

			/**
			 * https://qiita.com/alucky0707/items/de59e49de855e56be733
			 * オブジェクトのkeyとvaluesを反転させる
			 * (ex.
			 * "あ": ["阿波どこ","あはどこ","アはどこ"]
			 *   -> "阿波どこ":"あ", "あはどこ":"あ", "アはどこ":"あ"
			 * @param {Object} obj 反転させるオブジェクト
			 * @return {Object} keyとvaluesの反転したオブジェクト
			 */
			function inverseObject (obj) {
			  return Object.keys(obj).reduceRight(function (ret, k) {
					// "あ": ["阿波どこ","あはどこ","アはどこ"]
					// ここで配列を取得する
					obj[k].forEach(function( value ) {
						ret[value] = k
					});
			    return ret;
			  }, {});
			}

			// テスト用
			// https://hakuhin.jp/js/key_board.html
			// キーイベントリスナー関数
			function KeyDownFunc(e){

				// 入力情報を取得
				// キーコード
				var key_code = e.keyCode;
				// Shiftキーの押下状態
				var shift_key = e.shiftKey;
				// Ctrlキーの押下状態
				var ctrl_key = e.ctrlKey;
				// Altキーの押下状態
				var alt_key = e.altKey;

				// ↑は38
				console.log("code:" + key_code);

			}
			// イベントリスナーに対応している
			if(document.addEventListener){
				// キーボードを押したときに実行されるイベント
				document.addEventListener("keydown" , KeyDownFunc);
			// アタッチイベントに対応している
			}else if(document.attachEvent){
				// キーボードを押したときに実行されるイベント
				document.attachEvent("onkeydown" , KeyDownFunc);
			}


			// ひらがな -> ローマ字変換
			// https://github.com/cloneko/kana2romaji
			function kana2romaji(string) {

				var arrayedString = string.split('');
				var value = '';

				var triTable = {
			  	'う゛ぁ': 'VA','う゛ぃ' : 'VI', 'う゛ぅ' : 'VU','う゛ぇ' : 'VE', 'う゛ぉ' : 'VO'
				};

				var biTable = {
					'きゃ' : 'KYA','きゅ' : 'KYU','きょ' : 'KYO',
		      'ぎゃ' : 'GYA','ぎゅ' : 'GYU','ぎょ' : 'GYO',
		      'しゃ' : 'SHA','しゅ' : 'SHU','しょ' : 'SHO',
		      'じゃ' : 'JA','じゅ' : 'JU','じょ' : 'JO',
		      'ちゃ' : 'CHA','ちゅ' : 'CHU','ちょ' : 'CHO',
		      'ぢゃ' : 'DYA','ぢゅ' : 'DYU','ぢょ' : 'DYO',
		      'でゃ' : 'DHA','でゅ' : 'DHU','でょ' : 'DHO',
		      'にゃ' : 'NYA','にゅ' : 'NYU','にょ' : 'NYO',
		      'ひゃ' : 'HYA','ひゅ' : 'HYU','ひょ' : 'HYO',
		      'びゃ' : 'PYA','びゅ' : 'BYU','びょ' : 'BYO',
		      'みゃ' : 'MYA','みゅ' : 'MYU','みょ' : 'MYO',
		      'りゃ' : 'RYA','りゅ' : 'RYU','りょ' : 'RYO',
		      'てぁ' : 'THA','てぃ' : 'THI','てぇ' : 'TEE',
		      'う゛' : 'VU','あ゛' : 'A"',
		      'っか' : 'KKA','っき' : 'KKI','っく' : 'KKU','っけ' : 'KKE','っこ' : 'KKO',
		      'っさ' : 'SSA','っし' : 'SSHI','っす' : 'SSU','っせ' : 'SSE','っそ' : 'SSO',
		      'った' : 'TTA','っち' : 'CCHI','っつ' : 'TTU','って' : 'TTE','っと' : 'TTO',
		      'っな' : 'NNA','っに' : 'NNI','っぬ' : 'NNU','っね' : 'NNE','っの' : 'NNO',
		      'っは' : 'HHA','っひ' : 'HHI','っふ' : 'FFU','っへ' : 'HHE','っほ' : 'HHO',
		      'っま' : 'MMA','っみ' : 'MMI','っむ' : 'MMU','っめ' : 'MME','っも' : 'MMO',
		      'っや' : 'YYA', 'っゆ' : 'YYU','っよ' : 'YYO',
		      'っら' : 'RRA','っり' : 'RRI','っる' : 'RRU','っれ' : 'RRE','っろ' : 'RRO',
		      'っわ' : 'WWA',
		      'っが' : 'GGA','っぎ' : 'GGI','っぐ' : 'GGU','っげ' : 'GGE','っご' : 'GGO',
		      'っざ' : 'ZZA','っじ' : 'JJI','っず' : 'ZZU','っぜ' : 'ZZE','っぞ' : 'ZZO',
		      'っだ' : 'DDA','っぢ' : 'DDI','っづ' : 'DDU','っで' : 'DDE','っど' : 'DDO',
		      'っば' : 'BBA','っび' : 'BBI','っぶ' : 'BBU','っべ' : 'BBE','っぼ' : 'BBO',
		      'っぱ' : 'PPA','っぴ' : 'PPI','っぷ' : 'PPU','っぺ' : 'PPE','っぽ' : 'PPO'
				};

				var uniTable = {
					'あ' : 'A','い' : 'I','う' : 'U','え' : 'E','お' : 'O',
					'か' : 'KA','き' : 'KI','く' : 'KU','け' : 'KE','こ' : 'KO',
					'さ' : 'SA','し' : 'SHI','す' : 'SU','せ' : 'SE','そ' : 'SO',
					'た' : 'TA','ち' : 'CHI','つ' : 'TSU','て' : 'TE','と' : 'TO',
					'な' : 'NA','に' : 'NI','ぬ' : 'NU','ね' : 'NE','の' : 'NO',
					'は' : 'HA','ひ' : 'HI','ふ' : 'FU','へ' : 'HE','ほ' : 'HO',
					'ま' : 'MA','み' : 'MI','む' : 'MU','め' : 'ME','も' : 'MO',
					'や' : 'YA','ゆ' : 'YU','よ' : 'YO',
					'ら' : 'RA','り' : 'RI','る' : 'RU','れ' : 'RE','ろ' : 'RO',
					'わ' : 'WA','を' : 'WO','ん' : 'N',
					'が' : 'GA','ぎ' : 'GI','ぐ' : 'GU','げ' : 'GE','ご' : 'GO',
					'ざ' : 'ZA','じ' : 'JI','ず' : 'ZU','ぜ' : 'ZE','ぞ' : 'ZO',
					'だ' : 'DA','ぢ' : 'DI','づ' : 'DU','で' : 'DE','ど' : 'DO',
					'ば' : 'BA','び' : 'BI','ぶ' : 'BU','べ' : 'BE','ぼ' : 'BO',
					'ぱ' : 'PA','ぴ' : 'PI','ぷ' : 'PU','ぺ' : 'PE','ぽ' : 'PO',
					'ぁ' : 'XA','ぃ' : 'XI','ぅ' : 'XU','ぇ' : 'XE','ぉ' : 'XO',
					'ゃ' : 'XYA','ゅ' : 'XYU','ょ' : 'XYO','っ' : 'XTSU'
				};

				if(triTable[string] !== undefined){
			        return triTable[string];
				} else if(biTable[string] !== undefined) {
			        return biTable[string];
				}

			    var biCheck = new Object();
			    for (var k in biTable){
			        var tmp = k.split('');
			        biCheck[tmp[0]] = true;
			    }

			    var triCheck = new Object();
			    for (var tk in triTable){
			        var tmp = tk.split('');
			        triCheck[tmp[0] + tmp[1]] = true;
			        biCheck[tmp[0]] = true;
			    }


				var buf = '';
				for(var i = 0; i < arrayedString.length ; i++){
			        var str = arrayedString[i];
			        buf += str;
			        if(buf.length == 3){
			            if(triTable[buf] !== undefined){
			                value += triTable[buf];
			            } else {
			                tmp = buf.split('');
			                value += biTable[tmp[0] + tmp[1]];
			                value += uniTable[tmp[2]] === undefined ? tmp[2] : uniTable[tmp[2]];

			            }

			        } else if(buf.length == 2) {
			            if(triCheck[buf] !== undefined) {
			            } else if(biTable[buf] !== undefined) {
			                    value += biTable[buf];
			                    buf = '';
			                } else {
			                    tmp = buf.split('');
			                    value += uniTable[tmp[0]];
			                    value += uniTable[tmp[1]] === undefined ? tmp[1] : uniTable[tmp[1]];
			                    buf = '';
			                }
			        } else if(biCheck[buf] !== undefined){
			        } else {
			                value += uniTable[str] === undefined ? str : uniTable[str];
			                buf = '';
			        }


			        }

			        value += buf !== '' ? uniTable[buf] : '';

			    value = value.replace(/([aiueo])ー/gi,'$1');
				return value;
			}

		})(jQuery);
	</script>
</body>
</html>
